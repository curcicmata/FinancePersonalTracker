@using FinancePersonalTracker.Interface
@inject IFamilyGroupService FamilyGroupService
@inject AuthenticationStateProvider AuthStateProvider
@inject MudBlazor.IDialogService DialogService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">Create Family Group</MudText>

        <MudTextField Label="Group Name" @bind-Value="_groupName" Required="true" />

        <MudTextField Label="Invite Emails (comma separated)"
                      @bind-Value="_inviteEmails"
                      Placeholder="e.g. jane@example.com, john@example.com" />

    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CreateGroup">Create</MudButton>
        <MudButton Color="Color.Default" Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private string _groupName = string.Empty;
    private string _inviteEmails = string.Empty;
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    private async Task CreateGroup()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(c => c.Type.Contains("nameidentifier"))?.Value;

        if (string.IsNullOrWhiteSpace(_groupName) || string.IsNullOrWhiteSpace(userId))
        {
            Snackbar.Add("Group name is required.", Severity.Warning);
            return;
        }

        var group = await FamilyGroupService.CreateFamilyGroupAsync(_groupName, userId!);

        if (!string.IsNullOrWhiteSpace(_inviteEmails))
        {
            var emails = _inviteEmails.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
            foreach (var email in emails)
            {
                await FamilyGroupService.InviteUserAsync(group.Id, email);
            }
        }

        Snackbar.Add("Family group created successfully.", Severity.Success);
        MudDialog.Close(DialogResult.Ok(true));
    }


    void Submit() => MudDialog?.Close(DialogResult.Ok(true));
    void Cancel() => MudDialog.Cancel();
}
